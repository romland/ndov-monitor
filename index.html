<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NDOV High Density Grid</title>
    <style>
        :root { 
            --bg: #101010; 
            --text: #ccc; 
            --border: #2a2a2a; 
            --highlight: #333; 
            --accent: #0984e3;
        }
        body { 
            font-family: 'Roboto Mono', 'Consolas', monospace; 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; 
            font-size: 11px; 
            overflow: hidden; 
        }
        
        /* --- Top Bar --- */
        #top-bar { 
            height: 28px; 
            background: #1a1a1a; 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            align-items: center; 
            padding: 0 10px; 
            justify-content: space-between;
            font-size: 12px;
        }
        
        /* --- Grid Layout --- */
        #grid-container { 
            height: calc(100vh - 29px); 
            overflow-y: scroll; 
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            table-layout: fixed; /* Strict column widths */
        }
        
        thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th { 
            background: #202020; 
            text-align: left; 
            padding: 4px 6px; 
            border-bottom: 2px solid #444; 
            color: #fff;
            font-weight: 600;
            white-space: nowrap;
        }
        
        td { 
            border-bottom: 1px solid #1a1a1a; 
            padding: 2px 6px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            height: 20px;
        }
        
        tr { cursor: pointer; transition: background 0.1s; }
        tr:hover { background: var(--highlight) !important; color: #fff; }
        
        /* --- Column Widths (Total ~100% or overflow x) --- */
        .col-own    { width: 40px; color: #aaa; }
        .col-ln     { width: 50px; font-weight: bold; color: #fff; }
        .col-veh    { width: 60px; color: #fff; }
        .col-jrny   { width: 70px; color: #aaa; }
        .col-seq    { width: 35px; text-align: center; }
        .col-stat   { width: 75px; font-weight: bold; }
        .col-punc   { width: 50px; text-align: right; }
        .col-stop   { width: 180px; }
        .col-dist   { width: 60px; text-align: right; color: #aaa; }
        .col-src    { width: 60px; font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; }
        .col-gps    { width: 130px; font-size: 10px; color: #888; }
        .col-time   { width: 70px; }
        .col-upd    { width: 40px; text-align: center; color: #666; }

        /* --- Status Colors --- */
        .st-ARRIVAL   { color: #4cd137; }
        .st-DEPARTURE { color: #fbc531; }
        .st-ONROUTE   { color: #00a8ff; }
        .st-ONSTOP    { color: #e84118; }
        .st-INIT      { color: #9c88ff; }

        /* --- Punctuality --- */
        .late { color: #e84118; }
        .early { color: #fbc531; }
        .ok { color: #2ecc71; opacity: 0.7; }

        /* --- Sources --- */
        .src-VEHICLE { color: #2ecc71; }
        .src-SERVER  { color: #3498db; }

        /* --- Animation --- */
        @keyframes flash { 0% { background: #333; } 100% { background: transparent; } }
        .updated { animation: flash 0.8s ease-out; }

        /* --- Modal --- */
        #detail-modal {
            display: none; position: fixed; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); width: 600px; max-height: 80vh; 
            background: #181818; border: 1px solid #444; z-index: 1000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.9); overflow: hidden; display: flex; flex-direction: column;
        }
        #modal-header { padding: 10px; background: #222; border-bottom: 1px solid #333; display: flex; justify-content: space-between; }
        #modal-content { padding: 15px; overflow-y: auto; color: #a29bfe; }
        #modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 999; }
        .close { cursor: pointer; color: #fff; font-weight: bold; }


        /* NS Trains */
        .st-TRAIN { color: #f1c40f; font-weight: bold; }
    </style>
</head>
<body>

<div id="top-bar">
    <div><strong>NDOV</strong> Monitor <span style="color:#666">|</span> Full Stream</div>
    <div>
        Vehicles: <strong id="veh-count" style="color:#fff">0</strong> 
        <span style="color:#444; margin: 0 10px">|</span>
        Msg/Sec: <strong id="mps">0</strong>
    </div>
</div>

<div id="grid-container">
    <table>
        <thead>
            <tr>
                <th class="col-own" title="Operator">Op</th>
                <th class="col-ln" title="Line Number">Line</th>
                <th class="col-veh" title="Vehicle Number">Veh</th>
                <th class="col-jrny" title="Journey Number">Jrny</th>
                <th class="col-seq" title="Sequence">Seq</th>
                <th class="col-stat">Status</th>
                <th class="col-punc" title="Punctuality (sec)">+/-</th>
                <th class="col-stop" title="Target Stop Code">Stop</th>
                <th class="col-dist" title="Distance since last stop">Dist</th>
                <th class="col-src" title="Data Source">Src</th>
                <th class="col-gps">Lat, Lon</th>
                <th class="col-time">Time</th>
                <th class="col-upd" title="Update Count">#</th>
            </tr>
        </thead>
        <tbody id="grid-body"></tbody>
    </table>
</div>

<div id="modal-overlay" onclick="closeModal()"></div>
<div id="detail-modal" style="display:none">
    <div id="modal-header">
        <strong id="modal-title">Details</strong>
        <span class="close" onclick="closeModal()">âœ•</span>
    </div>
    <pre id="modal-content"></pre>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    const gridBody = document.getElementById('grid-body');
    const countSpan = document.getElementById('veh-count');
    const mpsSpan = document.getElementById('mps');

    const vehicles = new Map();
    let msgCounter = 0;

    // MPS Counter
    setInterval(() => { mpsSpan.innerText = msgCounter; msgCounter = 0; }, 1000);

    socket.on('update', (msgs) => {
        msgCounter += msgs.length;
        
        msgs.forEach(msg => {
            const id = `${msg.dataownercode}-${msg.vehiclenumber}`;
            
            // Increment local update count
            let prev = vehicles.get(id);
            msg.updateCount = (prev ? prev.updateCount : 0) + 1;
            
            vehicles.set(id, msg);
            renderRow(id, msg);
        });
        
        countSpan.innerText = vehicles.size;
    });

    function renderRow(id, msg) {
        let row = document.getElementById(id);
        
        // --- Formatting Helpers ---
        
        // Punctuality
        const punc = parseInt(msg.punctuality || 0);
        const puncClass = punc > 60 ? 'late' : (punc < -60 ? 'early' : 'ok');
        
        // GPS
        const gps = (msg.lat) ? `${msg.lat}, ${msg.lon}` : '';
        const gpsLink = (msg.lat) ? `<a href="https://www.google.com/maps?q=${msg.lat},${msg.lon}" target="_blank" style="color:inherit;text-decoration:none">${gps}</a>` : '';
        
        // Distance
        let dist = msg.distancesincelastuserstop || 0;
        let distStr = dist > 1000 ? (dist/1000).toFixed(1) + 'km' : dist + 'm';
        if (!msg.distancesincelastuserstop && msg.distancesincelastuserstop !== 0) distStr = '-';

        // Time (extract HH:MM:SS from ISO)
        // ISO: 2026-02-01T21:47:00.829...
        const timeStr = msg.timestamp ? msg.timestamp.split('T')[1].split('.')[0] : '';
        
        // Source Class
        const srcClass = `src-${msg.source}`;

        let stopDisplay = msg.userstopcode;
        if (msg.stopname) {
            stopDisplay = `<span style="color:#fff; border-bottom:1px dotted #555" title="${msg.userstopcode}">${msg.stopname}</span>`;
        }

        const html = `
            <td class="col-own">${msg.dataownercode}</td>
            <td class="col-ln">${msg.lineplanningnumber}</td>
            <td class="col-veh">${msg.vehiclenumber}</td>
            <td class="col-jrny">${msg.journeynumber}</td>
            <td class="col-seq">${msg.passagesequencenumber || 0}</td>
            <td class="col-stat st-${msg._type}">${msg._type}</td>
            <td class="col-punc ${puncClass}">${punc}</td>
            <td class="col-stop">${stopDisplay}</td>
            <td class="col-dist">${distStr}</td>
            <td class="col-src ${srcClass}">${msg.source || ''}</td>
            <td class="col-gps">${gpsLink}</td>
            <td class="col-time">${timeStr}</td>
            <td class="col-upd">${msg.updateCount}</td>
        `;

        if (!row) {
            row = document.createElement('tr');
            row.id = id;
            row.onclick = () => openModal(id);
            gridBody.appendChild(row);
        }

        row.innerHTML = html;
        
        // Re-trigger flash animation
        row.classList.remove('updated');
        void row.offsetWidth; // Force reflow
        row.classList.add('updated');
    }

    // --- Modal Logic ---
    const modal = document.getElementById('detail-modal');
    const overlay = document.getElementById('modal-overlay');
    const modalTitle = document.getElementById('modal-title');
    const modalContent = document.getElementById('modal-content');

    function openModal(id) {
        const data = vehicles.get(id);
        if(!data) return;

        modalTitle.innerText = `${data.dataownercode} - Vehicle ${data.vehiclenumber} (Line ${data.lineplanningnumber})`;
        modalContent.innerText = JSON.stringify(data, null, 2);
        
        modal.style.display = 'flex';
        overlay.style.display = 'block';
    }

    function closeModal() {
        modal.style.display = 'none';
        overlay.style.display = 'none';
    }
</script>
</body>
</html>

